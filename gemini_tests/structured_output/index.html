<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Structured output &#8212; AI data rescue: Daily precipitation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinxdoc.css?v=34905f61" />
    <script src="../../_static/documentation_options.js?v=d45e8c67"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Page locations" href="../page_locations/index.html" />
    <link rel="prev" title="Extracting a single measurement" href="../single_measurement/index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../page_locations/index.html" title="Page locations"
             accesskey="N">next</a></li>
        <li class="right" >
          <a href="../single_measurement/index.html" title="Extracting a single measurement"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">AI DR</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Structured output</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="structured-output">
<h1>Structured output<a class="headerlink" href="#structured-output" title="Link to this heading">¶</a></h1>
<p>It’s great to be able to ask questions in natural language, but we don’t want answers in natural language - we don’t want answers like ‘1.03 inches of rain fell on January 5th’, or ‘The rainfall on January 5th was 1.03 inches’, because we then have to parse those answers to use them in further processing. We just want the value - 1.03. We want specific, structured output.</p>
<p>A great virtue of Gemini is that it supports this, the API allows you to <a class="reference external" href="https://ai.google.dev/gemini-api/docs/structured-output?lang=python">specify the output structure you want</a>.</p>
<p>So we modify the code to define a data structure containing the exact output we want, and then we ask Gemini to populate that data structure from the image. We can then output the data structure as a JSON file, ready to use directly in our data processing pipeline.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># Basic test of the Gemini API - get the station metadata as</span>
<span class="c1">#  structured output.</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">PIL.Image</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">google.generativeai</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">genai</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">typing_extensions</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">typing</span>

<span class="c1"># You will need an API key get it from https://ai.google.dev/gemini-api/docs/api-key</span>

<span class="c1"># I keep my API key in the .gemini_api file in my home directory.</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">/.gemini_api&quot;</span> <span class="o">%</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s2">&quot;HOME&quot;</span><span class="p">),</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">api_key</span> <span class="o">=</span> <span class="n">file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="c1"># Default protocol is &#39;GRPC&#39; - but that is blocked by the Office firewall.</span>
<span class="c1">#  Use &#39;REST&#39; instead.</span>
<span class="n">genai</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">,</span> <span class="n">transport</span><span class="o">=</span><span class="s2">&quot;rest&quot;</span><span class="p">)</span>


<span class="c1"># Specify a structure for the desired output</span>
<span class="k">class</span><span class="w"> </span><span class="nc">MetaData</span><span class="p">(</span><span class="n">typing</span><span class="o">.</span><span class="n">TypedDict</span><span class="p">):</span>
    <span class="n">Year</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">StationNumber</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">Location</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">County</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">Sea_level_height</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">Gauge_diameter</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">Gauge_height_feet</span><span class="p">:</span> <span class="nb">int</span>
    <span class="n">Gauge_height_inches</span><span class="p">:</span> <span class="nb">int</span>


<span class="c1"># Load the sample image</span>
<span class="n">img</span> <span class="o">=</span> <span class="n">PIL</span><span class="o">.</span><span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
    <span class="s2">&quot;../../images/jpgs_300dpi/Devon_1941-1950_RainNos_1651-1689-293.jpg&quot;</span>
<span class="p">)</span>

<span class="c1"># Pick an AI to use - this one is the latest as of 2025-01-29</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">genai</span><span class="o">.</span><span class="n">GenerativeModel</span><span class="p">(</span><span class="s2">&quot;gemini-2.0-flash-exp&quot;</span><span class="p">)</span>

<span class="c1"># Ask a question about the image</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">generate_content</span><span class="p">(</span>
    <span class="p">[</span>
        <span class="n">img</span><span class="p">,</span>
        <span class="s2">&quot;</span><span class="se">\n\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;List the station metadata&quot;</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">generation_config</span><span class="o">=</span><span class="n">genai</span><span class="o">.</span><span class="n">GenerationConfig</span><span class="p">(</span>
        <span class="n">response_mime_type</span><span class="o">=</span><span class="s2">&quot;application/json&quot;</span><span class="p">,</span> <span class="n">response_schema</span><span class="o">=</span><span class="n">MetaData</span>
    <span class="p">),</span>
<span class="p">)</span>
<span class="c1"># Structured data as JSON</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;metadata.json&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">result</span><span class="o">.</span><span class="n">text</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;rest.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">file</span><span class="p">:</span>
    <span class="n">file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">result</span><span class="p">))</span>
</pre></div>
</div>
<p>This script extracts the station metadata, and stores it as JSON</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;County&quot;</span><span class="p">:</span> <span class="s2">&quot;DEVON&quot;</span><span class="p">,</span>
  <span class="s2">&quot;Gauge_diameter&quot;</span><span class="p">:</span> <span class="mi">5</span><span class="p">,</span>
  <span class="s2">&quot;Gauge_height_feet&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
  <span class="s2">&quot;Gauge_height_inches&quot;</span><span class="p">:</span> <span class="mi">3</span><span class="p">,</span>
  <span class="s2">&quot;Location&quot;</span><span class="p">:</span> <span class="s2">&quot;BADWORTHY COTTAGE, S. BRENT&quot;</span><span class="p">,</span>
  <span class="s2">&quot;Sea_level_height&quot;</span><span class="p">:</span> <span class="mi">550</span><span class="p">,</span>
  <span class="s2">&quot;StationNumber&quot;</span><span class="p">:</span> <span class="mi">1678</span><span class="p">,</span>
  <span class="s2">&quot;Year&quot;</span><span class="p">:</span> <span class="mi">1947</span>
<span class="p">}</span>
</pre></div>
</div>
<p>The data are all correct (compare <a class="reference internal" href="../../test_image.html"><span class="doc">the image</span></a>), and are ready to be used in further processing.</p>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../../index.html">
              <img class="logo" src="../../_static/AI_DR.webp" alt="Logo of AI data rescue: Daily precipitation"/>
            </a></p>
<h3><a href="../../index.html">Table Of Contents</a></h3>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../basic_api/index.html">Basic API function</a></li>
<li class="toctree-l1"><a class="reference internal" href="../single_measurement/index.html">Extracting a single data point</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Specifying an output structure</a></li>
<li class="toctree-l1"><a class="reference internal" href="../page_locations/index.html">Finding data locations on the page</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../how_to.html">How to reproduce or extend this work</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../credits.html">Authors and acknowledgements</a></li>
</ul>
<h3><a href="https://github.com/philip-brohan/AI_daily_precip">Get the code</a></h3>

<ul>
<li><a href="https://github.com/philip-brohan/AI_daily_precip"
           rel="nofollow">Github repository</a></li>
<li><a href="https://github.com/philip-brohan/AI_daily_precip/archive/master.zip"
           rel="nofollow">Zip file</a></li>
</ul>

<h3>Found a bug, or have a suggestion?</h3>

Please <a href="https://github.com/philip-brohan/AI_daily_precip/issues/new">raise an issue</a><br>or <a href="mailto://philip.brohan@metoffice.gov.uk">contact Philip</a>.
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../page_locations/index.html" title="Page locations"
             >next</a></li>
        <li class="right" >
          <a href="../single_measurement/index.html" title="Extracting a single measurement"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">AI DR</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Structured output</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    </div>
  </body>
</html>